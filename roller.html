<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>คำนวณราคาม่านม้วน</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/css/styles.css" rel="stylesheet">
  <script src="assets/js/theme.js"></script>
  <style>
    body{background:var(--pc-bg,#f7fbff)}
    .sidebar{min-width:260px;max-width:280px;background:var(--pc-panel,#0f172a);color:#e5e7eb}
    .sidebar .nav-link{color:#cbd5e1}
    .sidebar .nav-link.active,.sidebar .nav-link:hover{background:#1f2937;color:#fff}
    .topbar{position:sticky;top:0;z-index:1020;background:transparent;padding:8px 16px;display:flex;justify-content:flex-end}
    .theme-btn{border:none;background:#111827;color:#fff;border-radius:16px;padding:6px 12px;}
  </style>
</head>
<body>
<div class="topbar">
  <button onclick="PCToggleTheme()" class="theme-btn"><i class="bi bi-moon-stars"></i> โหมดมืด</button>
</div>
<div class="d-flex">
  <!-- Optional sidebar placeholder (safe to remove if your project already has sidebar via layout include) -->
  <aside class="sidebar p-3 d-none d-md-block">
    <h6 class="text-uppercase text-secondary">เมนู (ตัวอย่าง)</h6>
    <nav class="nav flex-column gap-1">
      <a class="nav-link px-3 py-2 rounded" href="index.html"><i class="bi bi-house me-2"></i>หน้าหลัก</a>
      <a class="nav-link px-3 py-2 rounded" href="pvc.html"><i class="bi bi-border-width me-2"></i>คำนวณฉากกั้นแอร์</a>
      <a class="nav-link px-3 py-2 rounded" href="woodblind.html"><i class="bi bi-window-split me-2"></i>คำนวณมู่ลี่ไม้</a>
      <a class="nav-link px-3 py-2 rounded active" href="roller.html"><i class="bi bi-rewind me-2"></i>คำนวณม่านม้วน</a>
      <a class="nav-link px-3 py-2 rounded" href="categories.html"><i class="bi bi-collection me-2"></i>หมวดหมู่เพิ่มเติม</a>
      <a class="nav-link px-3 py-2 rounded" href="admin.html"><i class="bi bi-gear me-2"></i>ผู้ดูแลระบบ</a>
    </nav>
  </aside>

  <main class="flex-grow-1 p-4">
    <div class="container-fluid">
      <h2 class="fw-bold text-center mb-3">คำนวณราคาม่านม้วน</h2>

      <div class="row g-3 align-items-end">
        <div class="col-md-6">
          <label class="form-label">เลือกผ้า/ชุดราคา</label>
          <select id="rbPrice" class="form-select"></select>
          <div class="form-text">เลือกกลุ่มผ้า ระบบจะแนะนำรหัสตามกลุ่มที่เลือก (ยังพิมพ์แก้เองได้)</div>
        </div>
        <div class="col-md-6 text-md-end">
          <button id="addRow" class="btn btn-outline-primary"><i class="bi bi-plus-circle me-1"></i>เพิ่มบรรทัด</button>
          <button id="calcBtn" class="btn btn-primary ms-2"><i class="bi bi-cpu me-1"></i>คำนวนราคา</button>
          <button id="pdfBtn" class="btn btn-success ms-2"><i class="bi bi-filetype-pdf me-1"></i>สร้าง PDF</button>
        </div>
      </div>

      <div class="card mt-4 shadow-sm border-0">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table align-middle" id="calcTable">
              <thead>
                <tr class="table-light">
                  <th style="width:60px">ลำดับ</th>
                  <th>รหัสสินค้า</th>
                  <th style="min-width:180px">เลือกผ้า/ราคา</th>
                  <th style="min-width:120px">ปรับ</th>
                  <th>กว้าง (ซม.)</th>
                  <th>สูง (ซม.)</th>
                  <th>จำนวนชุด</th>
                  <th class="text-end">ราคารวม (บาท)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="text-end fw-bold fs-5 mt-3">ยอดรวมสุทธิ: <span id="grandTotal">0.00</span> บาท</div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Modal ใบเสนอราคา -->
<div class="modal fade" id="quoteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ตัวอย่างใบเสนอราคา - ม่านม้วน</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="quoteArea"></div>
      <div class="modal-footer">
        <button id="captureImg" class="btn btn-outline-primary"><i class="bi bi-image me-1"></i>แคปภาพ</button>
        <button id="downloadPdf" class="btn btn-success"><i class="bi bi-filetype-pdf me-1"></i>ดาวน์โหลด PDF</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="assets/js/utils.js"></script>

<script>
// ===== กลุ่มผ้า + ราคา + รหัส (ฝังถาวรในไฟล์นี้) =====
const ROLLER_GROUPS = [
  { group: "Dimout • SOLIX", price: 290, codes: ["TML-5161","TML-5162","TML-5163","TML-5164","TML-5165"] },
  { group: "Dimout • SHEERO", price: 290, codes: ["TM-5101","TM-5103","TM-5104","TM-5121","TM-5122","TM-5123","TM-5124"] },
  { group: "Dimout • ARISO", price: 349, codes: ["MED-0062","MED-0064","MED-0065","MED-0066","MED-0067"] },
  { group: "Sunscreen • LUMI 3%", price: 280, codes: ["RSP301","RSP302","RSP303","RSP311"] },
  { group: "Sunscreen • LUMI 5%", price: 280, codes: ["RSP501","RSP502","RSP503","RSP505","RPS506","RSP509","RSP510","RSP511","RSP512"] },
  { group: "Blackout 100% • AUROSUN", price: 399, codes: ["A5-0002","A5-0003","A5-0004","A5-0005","A5-0006","A5-0007","A5-0008"] },
  { group: "Blackout 100% • BUOVI", price: 399, codes: ["SZH-0021","SZH-0022","SZH-0024","SZH-0028","SZH-0029"] },
  { group: "Blackout 100% • KOALA NOVA", price: 280, codes: ["RBP-3901","RBP-3902","RBP-3903","RBP-3908","RBP-3909","RBP-3910","RBP-3911","RBP-3912","RBP-3913","RBP-3914"] },
  { group: "Black out Promotion", price: 259, codes: ["RBP-3901","RBP-3902","RBP-3903","RBP-3908","RBP-3909","RBP-3910","RBP-3911","RBP-3912","RBP-3913","RBP-3914"] }
];

function formatMoney(n){return (n||0).toLocaleString('th-TH',{minimumFractionDigits:2,maximumFractionDigits:2});}

function refreshRBPrices(){
  const sel=document.getElementById('rbPrice');
  sel.innerHTML = ROLLER_GROUPS.map((g,idx)=>`<option value="${g.price}" data-idx="${idx}">${g.group} – ${g.price} บาท</option>`).join('');
}
refreshRBPrices();

const tbody=document.querySelector('#calcTable tbody');
let rowCount=0;

function newRow(){
  if(rowCount>=100) return;
  rowCount++;
  const dlId='dl_codes_'+rowCount;
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td>${rowCount}</td>
    <td>
      <input type="text" class="form-control form-control-sm code" list="${dlId}" placeholder="รหัสสินค้า (เลือก/พิมพ์เอง)">
      <datalist id="${dlId}"></datalist>
    </td>
    <td>
      <select class="form-select form-select-sm priceSel">${document.getElementById('rbPrice').innerHTML}</select>
      <small class="text-secondary">หรือใช้ราคาอื่น: </small>
      <input type="number" class="form-control form-control-sm mt-1 customLinePrice" placeholder="ราคาอื่น">
    </td>
    <td>
      <select class="form-select form-select-sm sideSel">
        <option value="ซ้าย">ปรับซ้าย</option>
        <option value="ขวา">ปรับขวา</option>
      </select>
    </td>
    <td><input type="number" class="form-control form-control-sm wVal" placeholder="เช่น 120"></td>
    <td><input type="number" class="form-control form-control-sm hVal" placeholder="เช่น 200"></td>
    <td><input type="number" class="form-control form-control-sm qtyVal" value="1" min="1"></td>
    <td class="text-end fw-semibold lineTotal">0.00</td>`;
  tbody.appendChild(tr);

  const priceSel=tr.querySelector('.priceSel');
  const dl=tr.querySelector('datalist');
  const updateCodes=()=>{
    const idx=priceSel.selectedIndex;
    const codes=ROLLER_GROUPS[idx]?.codes||[];
    dl.innerHTML = codes.map(c=>`<option value="${c}"></option>`).join('');
  };
  priceSel.addEventListener('change',updateCodes);
  updateCodes();
}
newRow();
document.getElementById('addRow').addEventListener('click',newRow);

function calcAll(){
  let grand=0;
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    const w=(parseFloat(tr.querySelector('.wVal').value)||0)/100;
    const h=(parseFloat(tr.querySelector('.hVal').value)||0)/100;
    const qty=parseInt(tr.querySelector('.qtyVal').value)||0;
    const sel=parseFloat(tr.querySelector('.priceSel').value)||0;
    const custom=parseFloat(tr.querySelector('.customLinePrice').value)||0;
    const price=custom>0?custom:sel;
    const total=w*h*1.2*price*qty;
    tr.querySelector('.lineTotal').textContent = formatMoney(total);
    grand += total;
  });
  document.getElementById('grandTotal').textContent = formatMoney(grand);
  return grand;
}
document.getElementById('calcBtn').addEventListener('click',calcAll);

// Modal quote preview / Save as image / PDF
const quoteModal=new bootstrap.Modal('#quoteModal');
document.getElementById('pdfBtn').addEventListener('click',()=>{
  const grand=calcAll();
  const rows=[...tbody.querySelectorAll('tr')].map((tr,i)=>({
    index:i+1,
    code:(tr.querySelector('.code').value||'-') + ' ('+(tr.querySelector('.sideSel').value||'-')+')',
    w:(parseFloat(tr.querySelector('.wVal').value)||0)/100,
    h:(parseFloat(tr.querySelector('.hVal').value)||0)/100,
    qty:parseInt(tr.querySelector('.qtyVal').value)||0,
    price:parseFloat(tr.querySelector('.customLinePrice').value)||parseFloat(tr.querySelector('.priceSel').value)||0,
    total:parseFloat((tr.querySelector('.lineTotal').textContent||'0').replace(/,/g,''))||0
  })).filter(r=>r.qty>0&&r.w>0&&r.h>0);

  const cm=v=>Math.round((v||0)*100);
  const rowsHtml=rows.map(r=>`
    <tr>
      <td>${r.index}</td>
      <td>${r.code}</td>
      <td>${cm(r.w)} x ${cm(r.h)} ซม.</td>
      <td class="text-center">${r.qty||1}</td>
      <td class="text-end">${r.price.toLocaleString('th-TH',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
      <td class="text-end fw-semibold">${r.total.toLocaleString('th-TH',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
    </tr>`).join('');

  const html = `
    <div class="p-3">
      <div class="mb-3">
        <h4 class="fw-bold mb-1">ใบเสนอราคา - ม่านม้วน</h4>
        <div class="text-secondary">${document.querySelector('#rbPrice option:checked')?.textContent||''}</div>
      </div>
      <div class="border rounded">
        <table class="table m-0">
          <thead class="table-light">
            <tr><th>ลำดับ</th><th>รหัสสินค้า</th><th>ขนาดที่คำนวณ (กว้าง x สูง)</th><th class="text-center">จำนวนชุด</th><th class="text-end">ราคา/ตร.ม.</th><th class="text-end">ราคารวม</th></tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
        <div class="p-3 text-end fw-bold">ยอดรวมสุทธิ: THB ${grand.toLocaleString('th-TH',{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
      </div>
    </div>`;

  document.getElementById('quoteArea').innerHTML=html;
  quoteModal.show();
});

document.getElementById('captureImg').addEventListener('click', async ()=>{
  const canvas=await html2canvas(document.getElementById('quoteArea'),{scale:2,backgroundColor:'#fff'});
  const a=document.createElement('a'); a.href=canvas.toDataURL('image/png'); a.download='ใบเสนอราคา-ม่านม้วน.png'; a.click();
});
document.getElementById('downloadPdf').addEventListener('click', ()=>{
  const { jsPDF }=window.jspdf;
  const pdf=new jsPDF('p','mm','a4');
  pdf.html(document.getElementById('quoteArea'),{callback:(d)=>d.save('ใบเสนอราคา-ม่านม้วน.pdf'),margin:[10,10,10,10],autoPaging:'text',html2canvas:{scale:0.7}});
});
</script>
</body>
</html>
